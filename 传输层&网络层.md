# 传输层



## IP地址



### IP地址分类

为了便于寻址以及层次化构造网络，每个IP地址包括两个标识码（ID），即**网络ID和主机ID**。同一个物理网络上的所有主机都使用同一个网络ID，网络上的一个主机（包括网络上工作站，服务器和路由器等）有一个主机ID与其对应。Internet委员会定义了5种IP地址类型以适合不同容量的网络，即A类~E类。

![ip地址分类](E:\Learning_year\资源图\ip地址分类.png)

![地址范围](E:\Learning_year\资源图\地址范围.png)



#### 为什么ipconfig查得的ip地址与在百度ip查询的地址不同？

```
ipconfig查出来的是你本机的IP地址，也就是内网私有地址，此类地址仅在局域网使用，不能联通外网。
百度查出来的地址是你上网的共有地址，也许并不是你主机的地址，而是电信或联通分给你的地址，用于连接互联网。
```



- Public IP : 公共 IP ，经由 INTERNIC 所统一规划的 IP，有这种 IP 才可以连上 Internet ；
- Private IP : 私有 IP 或保留 IP，不能直接连上 Internet 的 IP ，主要用于局域网络内的主机联机规划。

早在 IPv4 规划的时候就担心 IP 会有不足的情况，而且为了应付某些企业内部的网络设定，于是就有了私有IP (Private IP) 的产生了。私有 IP 也分别在 A, B, C 三个 Class 当中各保留一段作为私有 IP 网段，那就是：

- Class A：10.0.0.0  - 10.255.255.255
- Class B：172.16.0.0 - 172.31.255.255
- Class C：192.168.0.0 - 192.168.255.255



#### 私有ip如何访问公网？

PC通过私网ip向路由器发送请求，然后路由器使用公网ip对接网络，再把数据发送给Internet。然后internet回复数据到路由，再由路由在通过私网ip送回PC。



## NAT 技术

NAT(Net Address Translation)，工作原理：替换IP报文头部的地址信息。NAT通常部署在一个组织的网络出口位置，通过将内部网络IP地址替换为出口的IP地址提供公网可达性和上层协议的连接能力。



### PAT（Port Address Translation）

NAT重载也是动态NAT，它利用**源端口**将多个私网ip地址映射到一个公网ip地址(多对一)。这种技术称为PAT。

面对私网内部数量庞大的主机，如果NAT只进行IP地址的简单替换，就会产生一个问题：当有多个内部主机去访问同一个服务器时，从返回的信息不足以区分响应应该转发到哪个内部主机。此时，需要NAT设备根据传输层信息或其他上层协议去区分不同的会话，并且可能要对上层协议的标识进行转换，比如TCP或UDP端口号。这样NAT网关就可以将不同的内部连接访问映射到同一公网IP的不同传输层端口，通过这种方式实现公网IP的复用和解复用。

![PAT](E:\Learning_year\资源图\PAT.png)

### 

## DHCP协议

DHCP（动态主机配置协议）是一个局域网的网络协议，使用**UDP****协议**工作，常用的2个端口：67(DHCP server),68(DHCP client)。DHCP通常被用于局域网环境，主要作用是集中的管理、分配IP地址，使client动态的获得IP地址、Gateway地址、DNS服务器地址等信息，并能够提升地址的使用率。

![DHCP](E:\Learning_year\资源图\DHCP.png)

TCP/IP协议在初始化时，会自动调用DHCP模块，DHCP通过广播的方式去发现（**Discover**）DHCP服务器，如果本广播域没有服务器，通常会在网关上配置一个DHCP Relay + DHCP 服务器IP，一句话，肯定可以找到一个可以分配IP（**Offer**）的服务器。

通过四次消息交互，最后电脑获得了所有上网的的IP参数，IP地址、网络掩码、默认网关、DNS服务器，TCP/IP所有模块完成初始化，比如IP模块、DNS模块。

#### DHCP和NAT的区别：

​	DHCP为用户分配私有ip地址，NAT负责将私有ip转换为公有ip进行外网的访问。



## TCP/IP 协议

![协议类图](E:\Learning_year\资源图\协议类图.png)

TCP：一种面向连接的、可靠的、基于字节流的**传输层**通信协议

服务于**进程**间的通信

### TCP三次握手

#### 流程

![tcp三次握手](E:\Learning_year\资源图\tcp三次握手.gif)

![image-20210107152113521](C:\Users\11732\AppData\Roaming\Typora\typora-user-images\image-20210107152113521.png)

#### **tcp建立连接为什么是三次？**

- 为了实现可靠数据传输， TCP 协议的通信双方， 都必须维护一个序列号， 以标识发送出去的数据包中， 哪些是已经被对方收到的。 三次握手的过程即是通信双方相互告知序列号起始值， 并确认对方已经收到了序列号起始值的必经步骤
- 如果只是两次握手， 至多只有连接发起方的起始序列号能被确认， 另一方选择的序列号则得不到确认

#### **tcp握手中syn的值变化？**

ack 的作用是向对方表示，我期待收到的下一个序号。 如果你向对方回复了 ack = 31, 代表着你已经收到了序号截止到30的数据，期待的下一个数据起点是 31 。

TCP 协议规定SYN报文虽然不携带数据， 但是也要消耗1个序列号， 所以前两次握手客户端和服务端都需要向对方回复 x+1 或 y+1 。

*值得注意的是， 如上图所说， 最后一次握手在默认不携带数据的情况下， 由于SYN 不是 1 ， 是不消耗序列号的。 所以三次握手结束后， **客户端下一个发送的报文中** seq 依旧是 x+1， 示意图如下*

#### **tcp三次握手存在什么漏洞？可执行的攻击？**

**SYN攻击**
在三次握手过程中，服务器发送SYN-ACK之后，收到客户端的ACK之前的TCP连接称为半连接(half-open connect).此时服务器处于Syn_RECV状态.当收到ACK后，服务器转入ESTABLISHED状态.
Syn攻击就是 攻击客户端 在短时间内伪造大量不存在的IP地址，向服务器不断地发送syn包，服务器回复确认包，并等待客户的确认，由于源地址是不存在的，服务器需要不断的重发直 至超时，这些伪造的SYN包将长时间占用未连接队列，正常的SYN请求被丢弃，目标系统运行缓慢，严重者引起网络堵塞甚至系统瘫痪。
Syn攻击是一个典型的[DDOS](https://www.centos.bz/tag/ddos/)攻击。检测SYN攻击非常的方便，当你在服务器上看到大量的半连接状态时，特别是源IP地址是随机的，基本上可以断定这是一次SYN攻击.在[Linux](http://www.centos.bz/)下可以如下命令检测是否被Syn攻击

```
netstat -n -p TCP | grep SYN_RECV
```

### 

### TCP四次挥手	

​	注意与握手不同，服务端与客户端均可发起

![tcp四次挥手](E:\Learning_year\资源图\tcp四次挥手.png)

#### 流程

第一次挥手：A数据传输完毕需要断开连接，A的应用进程向其TCP发出连接释放报文段（FIN = 1,序号seq = u）,并停止再发送数据，主动关闭TCP连接，进入FIN-WAIT-1状态，等待B的确认。

第二次挥手：B收到连接释放报文段后即发出确认报文段（ACK=1，确认号ack=u+1,序号seq=v）,B进入CLOSE-WAIT关闭等待状态,此时的TCP处于半关闭状态，A到B的连接释放。而A收到B的确认后，进入FIN-WAIT-2状态，等待B发出的连接释放报文段。

第三次挥手：当B数据传输完毕后，B发出连接释放报文段（FIN = 1，ACK = 1，序号seq = w,确认号ack=u+1）,B进入LAST-ACK（最后确认）状态，等待A 的最后确认。

第四次挥手：A收到B的连接释放报文段后，对此发出确认报文段（ACK = 1，seq=u+1，ack=w+1）,A进入TIME-WAIT（时间等待）状态。此时TCP未释放掉，需要经过时间等待计时器设置的时间2MSL后，A才进入CLOSE状态。

![tcp四次挥手](http://www.centos.bz/wp-content/uploads/2012/08/100327022731.jpg)

#### **为什么建立连接协议是三次握手，而关闭连接却是四次握手呢？**

这是因为服务端的LISTEN状态下的SOCKET当收到SYN报文的连接请求后，它可以把ACK和SYN(ACK起应答作用，而SYN起同步作用)放在一个报文里来发送。但关闭连接时，当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了；但未必你所有的数据都全部发送给对方了，所以你可能未必会马上会关闭SOCKET,也即你可能还需要发送一些数据给对方之后，再发送FIN报文给对方来表示你同意现在可以关闭连接了，所以它这里的ACK报文和FIN报文多数情况下都是分开发送的。

# 网络层



### IP报文（IP数据报）

![ip报文](https://img-blog.csdn.net/20170301092349308)

**首部长度**：IP报头的长度。固定部分的长度（20字节）和可变部分的长度之和。共占4位。最大为1111，即10进制的15，代表IP报头的最大长度可以为15个32bits（4字节），也就是最长可为15*4=60字节，除去固定部分的长度20字节，可变部分的长度最大为40字节。

**标识**：唯一的标识主机发送的每一分数据报。通常每发送一个报文，它的值加一。当IP报文长度超过传输网络的MTU（最大传输单元）时必须分片，这个标识字段的值被复制到所有数据分片的标识字段中，使得这些分片在达到最终目的地时可以依照标识字段的内容重新组成原先的数据。

**片位移**：本分片在原先数据报文中相对首位的偏移位。

**生存时间**：IP报文所允许通过的路由器的最大数量。每经过一个路由器，TTL减1，当为0时，路由器将该数据报丢弃。TTL 字段是由发送端初始设置一个 8 bit字段.推荐的初始值由分配数字 RFC 指定，当前值为 64。发送 ICMP 回显应答时经常把 TTL 设为最大值 255。



